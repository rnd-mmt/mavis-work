hDh2299_Y(z$%fSigQvGfJk776qG4@aG9Gm{p+6ET775:#*!;S# -*- coding: utf-8 -*-
from datetime import datetime
from odoo import api, fields, models, _
from odoo.exceptions import UserError

class ProductTemplate(models.Model):
    _inherit = 'product.template'

    hospital_product_type = fields.Selection(selection_add=[('hospitalisation', 'Hospitalisation')])

class HealthService(models.Model):
    _name = 'acs.health_service'
    _description = 'Service Sante'
    _inherit = ['mail.thread', 'mail.activity.mixin', 'acs.hms.mixin']
    _order = 'id desc'

    STATES = {'invoiced': [('readonly', True)], 'cancel': [('readonly', True)], 'confirm': [('readonly', True)], 'requested': [('readonly', True)], 'done': [('readonly', True)]}

    @api.depends('service_line', 'service_line.amount_total')
    def _get_total_price(self):
        for rec in self:
            rec.total_price = sum(line.amount_total for line in rec.service_line)

    def _smart_rec_count(self):
        for rec in self:
            invoice_count = self.env['account.move'].search_count([('patient_id', '=', self.patient_id.id)])
            rec.invoice_count = invoice_count

    @api.onchange('patient_id')
    def onchange_dob(self):
        if self.patient_id:
            self.birthday = self.patient_id.birthday or False
            self.pricelist_id = self.patient_id.property_product_pricelist or False
            self.invoice_to = self.patient_id.partner_id.id or False

    @api.onchange('service_line','service_line.product_type')
    def onchange_show_rdv(self):
        if self.service_line:
             for line in self.service_line:
                 if line.product_type in ['consultation', 'surgery', 'radio_int']:
                     self.show_rdv = True
                 else:
                    pass

    @api.onchange('service_line')
    def onchange_show_pricelist(self):
        if not self.service_line:
            self.show_update_pricelist = True

    name = fields.Char(string='ID', readonly=True)
    desc = fields.Char(string='Description', states=STATES)
    patient_id = fields.Many2one('hms.patient', string='Patient', required=True, states=STATES , tracking=True)
    birthday = fields.Date(string='Date of Birth', tracking=True, readonly=True)
    company_id = fields.Many2one('res.company', ondelete='restrict', 
        string='Company', default=lambda self: self.env.company.id, states=STATES, tracking=True)

    service_date = fields.Date(string='Date', default=fields.Date.context_today, states=STATES, tracking=True)
    service_line = fields.One2many('acs.health_service.line', 'service_id', string='Ligne', help="Ligne de service", states=STATES)
    state = fields.Selection([
        ('draft', 'Draft'),
        ('proforma', 'Demande de Proforma'),
        ('confirm', 'Confirmé'),
        ('invoiced', 'Facture créée'),
        ('requested', 'Demande examens créé'),
        ('cancel', 'Annulé'),
        ('editable', 'Rendre editable'),
        ('done', 'Fait'),
        ], string='State', default='draft', readonly=True, tracking=True)
    invoice_to = fields.Many2one('res.partner', string='Facturer à', states=STATES)
    pricelist_id = fields.Many2one('product.pricelist', string='Pricelist', check_company=True, states=STATES, tracking=True,
        domain="['|', ('company_id', '=', False), ('company_id', '=', company_id)]",
        help="Si vous modifiez la liste de prix, la facture correspondante sera affectée.")
    show_update_pricelist = fields.Boolean(string='Has Pricelist Changed',
                                           default=True)
    currency_id = fields.Many2one(related='pricelist_id.currency_id', depends=["pricelist_id"], store=True)
    #physician_id = fields.Many2one('hms.physician', string='Médecin prescripteur', ondelete='restrict', states=STATES, tracking=True)
    physician_id = fields.Many2many('hms.physician', string='Rendez-vous avec', ondelete='restrict', states=STATES, tracking=True)
    prescripteur = fields.Many2one('res.partner', string='Médecin prescripteur', domain=[('is_referring_doctor', '=', True)],states=STATES)
    nurse_id = fields.Many2one('hr.employee', string='Nurse', default=lambda self: self.env.user.employee_id.id,
                               states=STATES, tracking=True)
    total_price = fields.Float(compute="_get_total_price", string='Total', store=True, tracking=True)
    notes = fields.Text(string='Notes', states=STATES)
    invoice_id = fields.Many2one('account.move', string='Invoice', copy=False, states=STATES)
    ref_acte = fields.Char(string='Référence acte', readonly=True)
    invoice_count = fields.Integer(compute='_smart_rec_count', string='Facture')
    # =======INFO SUR PAIEMENT======
    mode_payd = fields.Many2one('account.journal', string="Mode de paiement",
                                   domain="[('company_id', '=', company_id), ('type', 'in', ('bank', 'cash'))]")
    ref_payd = fields.Char(string="Numéro de paiement")
    department_id = fields.Many2one('hr.department', ondelete="restrict",
                                    string='Department', domain=[('patient_department', '=', True)],
                                    states=STATES)
    #=======GROUPE DE REQUETE======
    is_group_request = fields.Boolean(default=False, states=STATES)
    group_patient_ids = fields.Many2many("hms.patient", "hms_patient_service_req_rel", "request_id", "patient_id",
                                         string="Autres patients du groupe", states=STATES)
    #======BANNIERE SMI=====
    smi = fields.Boolean(string='Membre SMI')
    show_rdv = fields.Boolean(string='Est consultation', default=False)

    _sql_constraints = [
        ('name_uniq', 'unique (name)', "ID doit etre unique !"),
    ]

    @api.model
    def create(self, vals):
        vals['name'] = self.env['ir.sequence'].next_by_code('acs.health_service')
        return super(HealthService, self).create(vals)

    def unlink(self):
        for rec in self:
            if rec.state not in ['draft']:
                raise UserError(_("Record can be delete only in Draft state."))
        return super(HealthService, self).unlink()

    def button_draft(self):
        self.state = 'draft'

    def button_proforma(self):
        self.state = 'proforma'

    def button_confirm(self):
        self.state = 'confirm'

    def button_cancel(self):
        self.state = 'cancel'

    def button_done(self):
        self.state = 'done'

    def set_editable(self):
        self.state = 'editable'

    def re_done(self):
        self.state = 'done'

    # CREATION LAB TEST
    def generate_labrequest(self):
        self.ensure_one()
        labtest_line_vals = []
        for line in self.service_line:
            if line.product_type == "pathology":
                vals = {
                    'test_id': self.env['acs.lab.test'].search([('product_id', '=', line.product.id)]).id,
                    'sale_price': line.sale_price,
                }
                labtest_line_vals.append((0, 0, vals))
            else:
                pass
        vals_labrequest = []
        patients = self.mapped('patient_id') + self.mapped('group_patient_ids')
        for patient in patients:
            labrequest_vals = {
                #'patient_id': self.patient_id.id,
                'patient_id': patient.id,
                #'physician_id': self.physician_id.id,
                'prescripteur': self.prescripteur.id,
                'health_service_id': self.id,
                'line_ids': labtest_line_vals,
                # 'department_id': self.department_id.id,
                # 'file_patient': self.file_patient,
                # 'clinic_info' : self.lab_clinic_info,
            }
            if len(labtest_line_vals) > 0:
                lab_request = self.env['acs.laboratory.request'].sudo().create(labrequest_vals)
                vals_labrequest.append((4, lab_request.id))
            else:
                pass

    def generate_ctrequest(self):
        self.ensure_one()
        ct_line_vals = []
        for line in self.service_line:
            if line.product_type == "CT":
                vals = {
                    'test_id': self.env['acs.imaging.test'].search([('product_id', '=', line.product.id)]).id,
                    'sale_price': line.sale_price,
                    #'pdc': line.pdc,
                }
                ct_line_vals.append((0, 0, vals))
            else:
                pass
        vals_imgrequest = []
        patients = self.mapped('patient_id') + self.mapped('group_patient_ids')
        for patient in patients:
            ct_vals = {
                'patient_id': patient.id,
               # 'physician_id': self.physician_id.id,
                'health_service_id': self.id,
                'line_ids': ct_line_vals,
                #'department_id': self.department_id.id,
                'test_type': 'CT',
                #'file_patient': self.file_patient,
                # 'clinic_info': self.lab_clinic_info,
                'prescripteur': self.prescripteur.id,
                
            }
            if len(ct_line_vals) > 0:
                img_request = self.env['acs.imaging.request'].sudo().create(ct_vals)
                vals_imgrequest.append((4, img_request.id))
                self.check_img = True
            else:
                pass

    def generate_mrrequest(self):
        self.ensure_one()
        mr_line_vals = []
        for line in self.service_line:
            if line.product_type == "MR":
                vals = {
                    'test_id': self.env['acs.imaging.test'].search([('product_id', '=', line.product.id)]).id,
                    'sale_price': line.sale_price,
                    #'pdc': line.pdc,
                }
                mr_line_vals.append((0, 0, vals))
            else:
                pass
        vals_imgrequest = []
        patients = self.mapped('patient_id') + self.mapped('group_patient_ids')
        for patient in patients:
            mr_vals = {
                'patient_id': patient.id,
               # 'physician_id': self.physician_id.id,
                'health_service_id': self.id,
                'line_ids': mr_line_vals,
                #'department_id': self.department_id.id,
                'test_type': 'MR',
                # 'file_patient': self.file_patient,
                # 'clinic_info': self.lab_clinic_info,
                'prescripteur': self.prescripteur.id,
            }
            if len(mr_line_vals) > 0:
                img_request = self.env['acs.imaging.request'].sudo().create(mr_vals)
                vals_imgrequest.append((4, img_request.id))
                self.check_img = True
            else:
                pass

    def generate_explorationrequest(self):
        self.ensure_one()
        exploration_line_vals = []
        for line in self.service_line:
            if line.product_type == "exploration":
                vals = {
                    'test_id': self.env['acs.imaging.test'].search([('product_id', '=', line.product.id)]).id,
                    'sale_price': line.sale_price,
                    #'pdc': line.pdc,
                }
                exploration_line_vals.append((0, 0, vals))
            else:
                pass
        vals_imgrequest = []
        patients = self.mapped('patient_id') + self.mapped('group_patient_ids')
        for patient in patients:
            exploration_vals = {
                'patient_id': patient.id,
                #'physician_id': self.physician_id.id,
                'health_service_id': self.id,
                'line_ids': exploration_line_vals,
                #'department_id': self.department_id.id,
                'test_type': 'exploration',
                # 'file_patient': self.file_patient,
                # 'clinic_info': self.lab_clinic_info,
                'prescripteur': self.prescripteur.id,
            }
            if len(exploration_line_vals) > 0:
                img_request = self.env['acs.imaging.request'].sudo().create(exploration_vals)
                vals_imgrequest.append((4, img_request.id))
                self.check_img = True
            else:
                pass

    def generate_crrequest(self):
        self.ensure_one()
        cr_line_vals = []
        for line in self.service_line:
            if line.product_type == "CR":
                vals = {
                    'test_id': self.env['acs.imaging.test'].search([('product_id', '=', line.product.id)]).id,
                    'sale_price': line.sale_price,
                    #'pdc': line.pdc,
                }
                cr_line_vals.append((0, 0, vals))
            else:
                pass
        vals_imgrequest = []
        patients = self.mapped('patient_id') + self.mapped('group_patient_ids')
        for patient in patients:
            cr_vals = {
                # 'patient_id': self.patient_id.id,
                'patient_id': patient.id,
                #'physician_id': self.physician_id.id,
                'health_service_id': self.id,
                'line_ids': cr_line_vals,
                #'department_id': self.department_id.id,
                'test_type': 'CR',
                # 'file_patient': self.file_patient,
                # 'clinic_info': self.lab_clinic_info,
                'prescripteur': self.prescripteur.id,
            }
            if len(cr_line_vals) > 0:
                img_request = self.env['acs.imaging.request'].sudo().create(cr_vals)
                vals_imgrequest.append((4, img_request.id))
                self.check_img = True
            else:
                pass

    def generate_usrequest(self):
        self.ensure_one()
        us_line_vals = []
        for line in self.service_line:
            if line.product_type == "US":
                vals = {
                    'test_id': self.env['acs.imaging.test'].search([('product_id', '=', line.product.id)]).id,
                    'sale_price': line.sale_price,
                    #'pdc': line.pdc,
                }
                us_line_vals.append((0, 0, vals))
            else:
                pass
        vals_imgrequest = []
        patients = self.mapped('patient_id') + self.mapped('group_patient_ids')
        for patient in patients:
            us_vals = {
                # 'patient_id': self.patient_id.id,
                'patient_id': patient.id,
                #'physician_id': self.physician_id.id,
                'health_service_id': self.id,
                'line_ids': us_line_vals,
                #'department_id': self.department_id.id,
                'test_type': 'US',
                # 'file_patient': self.file_patient,
                # 'clinic_info': self.lab_clinic_info,
                'prescripteur': self.prescripteur.id,
            }
            if len(us_line_vals) > 0:
                img_request = self.env['acs.imaging.request'].sudo().create(us_vals)
                vals_imgrequest.append((4, img_request.id))
                self.check_img = True
            else:
                pass

    def generate_mggrequest(self):
        self.ensure_one()
        mg_line_vals = []
